<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>SAM Readme &#8212; Plant Tracer Web Application 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <script src="_static/documentation_options.js?v=f2a433a1"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Notes on Deploying to SAM" href="sam_notes.html" />
    <link rel="prev" title="Configuring AWS" href="configuring_aws.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="sam-readme">
<h1>SAM Readme<a class="headerlink" href="#sam-readme" title="Link to this heading">¶</a></h1>
<section id="planttracer-webapp">
<h2>planttracer-webapp<a class="headerlink" href="#planttracer-webapp" title="Link to this heading">¶</a></h2>
<p>This project contains source code and supporting files for a serverless application that we deploy with the SAM CLI. It includes the following files and folders.</p>
<ul class="simple">
<li><p>deploy - Code for the application’s Lambda function.</p></li>
<li><p>deploy/Dockerfile - creates the container, installing all packages in deploy/requirements.txt</p></li>
<li><p>events - Invocation events that one day will be used to test invoking the function</p></li>
<li><p>tests - Unit tests that will one day be used to test the application code.</p></li>
<li><p>template.yaml - The template that defines the application’s AWS resources.</p></li>
</ul>
</section>
<section id="deploy-the-application">
<h2>Deploy the application<a class="headerlink" href="#deploy-the-application" title="Link to this heading">¶</a></h2>
<p>The Serverless Application Model Command Line Interface (SAM CLI) is an extension of the AWS CLI that adds functionality for building and testing Lambda applications. It uses Docker to run your functions in an Amazon Linux environment that matches Lambda. It can also emulate your application’s build environment and API.</p>
<p>To use the SAM CLI, you need the following tools.</p>
<ul class="simple">
<li><p>SAM CLI - <a class="reference external" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html">Install the SAM CLI</a></p></li>
<li><p><a class="reference external" href="https://www.python.org/downloads/">Python 3 installed</a></p></li>
<li><p>Docker - <a class="reference external" href="https://hub.docker.com/search/?type=edition&amp;amp;offering=community">Install Docker community edition</a></p></li>
</ul>
<p>To build and deploy your application for the first time, run the following in your shell:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sam<span class="w"> </span>build<span class="w"> </span>--use-container
sam<span class="w"> </span>deploy<span class="w"> </span>--guided
</pre></div>
</div>
<p>The first command will build the source of your application. The second command will package and deploy your application to AWS, with a series of prompts:</p>
<ul class="simple">
<li><p><strong>Stack Name</strong>: The name of the stack to deploy to CloudFormation. This should be unique to your account and region, and a good starting point would be something matching your project name.</p></li>
<li><p><strong>AWS Region</strong>: The AWS region you want to deploy your app to.</p></li>
<li><p><strong>Confirm changes before deploy</strong>: If set to yes, any change sets will be shown to you before execution for manual review. If set to no, the AWS SAM CLI will automatically deploy application changes.</p></li>
<li><p><strong>Allow SAM CLI IAM role creation</strong>: Many AWS SAM templates, including this example, create AWS IAM roles required for the AWS Lambda function(s) included to access AWS services. By default, these are scoped down to minimum required permissions. To deploy an AWS CloudFormation stack which creates or modifies IAM roles, the <code class="docutils literal notranslate"><span class="pre">CAPABILITY_IAM</span></code> value for <code class="docutils literal notranslate"><span class="pre">capabilities</span></code> must be provided. If permission isn’t provided through this prompt, to deploy this example you must explicitly pass <code class="docutils literal notranslate"><span class="pre">--capabilities</span> <span class="pre">CAPABILITY_IAM</span></code> to the <code class="docutils literal notranslate"><span class="pre">sam</span> <span class="pre">deploy</span></code> command.</p></li>
<li><p><strong>Save arguments to samconfig.toml</strong>: If set to yes, your choices will be saved to a configuration file inside the project, so that in the future you can just re-run <code class="docutils literal notranslate"><span class="pre">sam</span> <span class="pre">deploy</span></code> without parameters to deploy changes to your application.</p></li>
</ul>
<p>You can find your API Gateway Endpoint URL in the output values displayed after deployment.</p>
</section>
<section id="use-the-sam-cli-to-build-and-test-locally">
<h2>Use the SAM CLI to build and test locally<a class="headerlink" href="#use-the-sam-cli-to-build-and-test-locally" title="Link to this heading">¶</a></h2>
<p>Build your application with the <code class="docutils literal notranslate"><span class="pre">sam</span> <span class="pre">build</span> <span class="pre">--use-container</span></code> command.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>planttracer-webapp$<span class="w"> </span>sam<span class="w"> </span>build<span class="w"> </span>--use-container
</pre></div>
</div>
<p>NOTE:</p>
<ul class="simple">
<li><p>This only works if your systems is configured for AWS. (e.g. <code class="docutils literal notranslate"><span class="pre">$HOME/.aws/credentails</span></code>) are problerly configured.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>planttracer-webapp$<span class="w"> </span>sam<span class="w"> </span><span class="nb">local</span><span class="w"> </span>invoke<span class="w"> </span>HelloWorldFunction<span class="w"> </span>--event<span class="w"> </span>events/event.json
</pre></div>
</div>
<p>The SAM CLI can also emulate your application’s API. Use the <code class="docutils literal notranslate"><span class="pre">sam</span> <span class="pre">local</span> <span class="pre">start-api</span></code> to run the API locally on port 3000.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>planttracer-webapp$<span class="w"> </span>sam<span class="w"> </span><span class="nb">local</span><span class="w"> </span>start-api
planttracer-webapp$<span class="w"> </span>curl<span class="w"> </span>http://localhost:3000/
</pre></div>
</div>
<p>The SAM CLI reads the application template to determine the API’s routes and the functions that they invoke. The <code class="docutils literal notranslate"><span class="pre">Events</span></code> property on each function’s definition includes the route and method for each path.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="nt">Events</span><span class="p">:</span>
<span class="w">        </span><span class="nt">HelloWorld</span><span class="p">:</span>
<span class="w">          </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Api</span>
<span class="w">          </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">            </span><span class="nt">Path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/hello</span>
<span class="w">            </span><span class="nt">Method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">get</span>
</pre></div>
</div>
</section>
<section id="fetch-tail-and-filter-lambda-function-logs">
<h2>Fetch, tail, and filter Lambda function logs<a class="headerlink" href="#fetch-tail-and-filter-lambda-function-logs" title="Link to this heading">¶</a></h2>
<p>To simplify troubleshooting, SAM CLI has a command called <code class="docutils literal notranslate"><span class="pre">sam</span> <span class="pre">logs</span></code>. <code class="docutils literal notranslate"><span class="pre">sam</span> <span class="pre">logs</span></code> lets you fetch logs generated by your deployed Lambda function from the command line. In addition to printing the logs on the terminal, this command has several nifty features to help you quickly find the bug.</p>
<p><code class="docutils literal notranslate"><span class="pre">NOTE</span></code>: This command works for all AWS Lambda functions; not just the ones you deploy using SAM.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>planttracer-webapp$<span class="w"> </span>sam<span class="w"> </span>logs<span class="w">  </span>--tail
</pre></div>
</div>
<p>Or, more specifically:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>planttracer-webapp$ sam logs -n HelloWorldFunction --stack-name &quot;planttracer-webapp&quot; --tail
</pre></div>
</div>
<p>For more information, see:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-logging.html">SAM CLI Documentation</a>.</p></li>
</ul>
</section>
<section id="tests">
<h2>Tests<a class="headerlink" href="#tests" title="Link to this heading">¶</a></h2>
<p>Tests are defined in the <code class="docutils literal notranslate"><span class="pre">tests</span></code> folder in this project. Use PIP to install the test dependencies and run tests.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>planttracer-webapp$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>tests/requirements.txt<span class="w"> </span>--user
<span class="c1"># unit test</span>
planttracer-webapp$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests/unit<span class="w"> </span>-v
<span class="c1"># integration test, requiring deploying the stack first.</span>
<span class="c1"># Create the env variable AWS_SAM_STACK_NAME with the name of the stack we are testing</span>
planttracer-webapp$<span class="w"> </span><span class="nv">AWS_SAM_STACK_NAME</span><span class="o">=</span><span class="s2">&quot;planttracer-webapp&quot;</span><span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests/integration<span class="w"> </span>-v
</pre></div>
</div>
</section>
<section id="cleanup">
<h2>Cleanup<a class="headerlink" href="#cleanup" title="Link to this heading">¶</a></h2>
<p>To delete the sample application that you created, use the AWS CLI. Assuming you used your project name for the stack name, you can run the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sam<span class="w"> </span>delete<span class="w"> </span>--stack-name<span class="w"> </span><span class="s2">&quot;planttracer-webapp&quot;</span>
</pre></div>
</div>
</section>
<section id="educational-resources">
<h2>Educational Resources<a class="headerlink" href="#educational-resources" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html">AWS SAM developer guide</a></p></li>
<li><p><a class="reference external" href="https://aws.amazon.com/serverless/serverlessrepo/">AWS Serverless Application Repository main page</a></p></li>
</ul>
</section>
</section>
<section id="sam-programmer-notes">
<h1>SAM Programmer notes<a class="headerlink" href="#sam-programmer-notes" title="Link to this heading">¶</a></h1>
<section id="handling-binary-types">
<h2>Handling binary types<a class="headerlink" href="#handling-binary-types" title="Link to this heading">¶</a></h2>
<p>https://chatgpt.com/share/676099eb-30a8-8010-841a-f2ed04a8dcff</p>
<p>You:</p>
<p>I have a bottle python application running in lambda. I’m getting utf-8 decoding errors when static files are served. One is a .mp3 file.  One is favicon.ico. One is a JSON object. These didn’t happen when I ran under Zappa but they are now happening after I switched to SAM.  Here is the error; how do I fix? 2024/12/16/[$LATEST]38f3b8b8966f4b0385db87164f2683d8 2024-12-16T21:18:20.299000 LAMBDA_WARNING: Unhandled exception. The most likely cause is an issue in the function code. However, in rare cases, a Lambda runtime update can cause unexpected function behavior. For functions using managed runtimes, runtime updates can be triggered by a function change, or can be applied automatically. To determine if the runtime has been updated, check the runtime version in the INIT_START log entry. If this error correlates with a change in the runtime version, you may be able to mitigate this error by temporarily rolling back to the previous runtime     response[“body”] = self.body.getvalue().decode(“utf-8”)pig_responseition 0: invalid start byteml</p>
<p>ChatGPT:</p>
<p>The issue lies in the encoding assumption when serving static files or generating responses in your Bottle application running on AWS Lambda. Specifically, your application attempts to decode binary content (e.g., <code class="docutils literal notranslate"><span class="pre">.mp3</span></code>, <code class="docutils literal notranslate"><span class="pre">favicon.ico</span></code>) or incorrectly handles content types like JSON, leading to <code class="docutils literal notranslate"><span class="pre">utf-8</span></code> decoding errors.
Here’s how to fix it:</p>
<ol class="arabic simple">
<li><p><strong>Update Static File Handling</strong>
Ensure that static files are served as binary content without attempting UTF-8 decoding:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bottle</span><span class="w"> </span><span class="kn">import</span> <span class="n">static_file</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/static/&lt;filename&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">serve_static</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">static_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s1">&#39;./static&#39;</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;application/octet-stream&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>For specific file types like <code class="docutils literal notranslate"><span class="pre">.mp3</span></code> and <code class="docutils literal notranslate"><span class="pre">.ico</span></code>, ensure the <code class="docutils literal notranslate"><span class="pre">mimetype</span></code> is correctly set (e.g., <code class="docutils literal notranslate"><span class="pre">audio/mpeg</span></code> for <code class="docutils literal notranslate"><span class="pre">.mp3</span></code> or <code class="docutils literal notranslate"><span class="pre">image/x-icon</span></code> for <code class="docutils literal notranslate"><span class="pre">.ico</span></code>).2. <strong>Fix JSON Encoding</strong> JSON responses must be explicitly encoded and returned as UTF-8. Instead of returning plain JSON strings, set the <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> header and ensure the response body is serialized correctly:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bottle</span><span class="w"> </span><span class="kn">import</span> <span class="n">response</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/data&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">json_response</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">}</span>
    <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">json.dumps</span></code> generates binary output, it’s safe to return it without decoding to UTF-8.3. <strong>Avoid Automatic UTF-8 Decoding in Lambda Handler</strong> AWS Lambda’s integration with API Gateway or ALB might try to decode the response body. Ensure the response uses the correct <code class="docutils literal notranslate"><span class="pre">isBase64Encoded</span></code> flag for binary content:</p>
<ul class="simple">
<li><p>Update your Lambda function to include this flag in the response for binary files:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>

<span class="k">def</span><span class="w"> </span><span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c1"># Example for serving binary files</span>
    <span class="n">binary_content</span> <span class="o">=</span> <span class="n">load_binary_file</span><span class="p">(</span><span class="s1">&#39;path/to/favicon.ico&#39;</span><span class="p">)</span>  <span class="c1"># Replace with your binary file loader</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;image/x-icon&quot;</span><span class="p">},</span>
        <span class="s2">&quot;isBase64Encoded&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">binary_content</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>In <code class="docutils literal notranslate"><span class="pre">template.yaml</span></code> for SAM, declare binary media types:</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">Resources</span><span class="p">:</span>
<span class="w">  </span><span class="nt">Api</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Api</span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">BinaryMediaTypes</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">image/x-icon</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audio/mpeg</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">application/json</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p><strong>Update Dependencies</strong></p></li>
</ol>
<ul class="simple">
<li><p>Ensure you are using a compatible version of <code class="docutils literal notranslate"><span class="pre">bottle</span></code>, and update any middleware or custom handlers introduced for Lambda or SAM deployment.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>bottle
</pre></div>
</div>
<ul class="simple">
<li><p>If you’re using additional packages for Lambda integration (e.g., <code class="docutils literal notranslate"><span class="pre">bottle-lambda</span></code>), ensure they handle binary content correctly.</p></li>
</ul>
<ol class="arabic simple" start="5">
<li><p><strong>Debugging</strong> Add logging to your application to verify the <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> headers and binary file serving logic:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/debug/&lt;filename&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">debug_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Serving file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">static_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s1">&#39;./static&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Use CloudWatch logs to inspect these values.</p>
<section id="summary">
<h3>Summary:<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Serve static files with proper <code class="docutils literal notranslate"><span class="pre">mimetype</span></code> and avoid UTF-8 decoding.</p></li>
<li><p>Handle JSON explicitly using <code class="docutils literal notranslate"><span class="pre">json.dumps</span></code> and set <code class="docutils literal notranslate"><span class="pre">Content-Type:</span> <span class="pre">application/json</span></code>.</p></li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">isBase64Encoded</span></code> flag in Lambda responses for binary files.</p></li>
<li><p>Declare binary media types in the SAM template for API Gateway.</p></li>
</ul>
<p>If these steps don’t resolve the issue, provide more context about your SAM template and Lambda handler for further debugging.</p>
<p>You:</p>
<p>what does   “isBase64Encoded”: True, do?</p>
<p>ChatGPT:</p>
<p>The <code class="docutils literal notranslate"><span class="pre">&quot;isBase64Encoded&quot;:</span> <span class="pre">True</span></code> flag in an AWS Lambda response tells API Gateway (or other AWS services handling the response) that the <code class="docutils literal notranslate"><span class="pre">body</span></code> field contains binary data encoded as a Base64 string.</p>
</section>
<section id="why-it-s-needed">
<h3>Why It’s Needed<a class="headerlink" href="#why-it-s-needed" title="Link to this heading">¶</a></h3>
<p>AWS API Gateway transmits responses as JSON objects to clients. Since JSON does not natively support raw binary data, binary content must be encoded in a way that is safe to include in a JSON string. Base64 encoding is commonly used for this purpose because it converts binary data into a text-based format.
When the <code class="docutils literal notranslate"><span class="pre">isBase64Encoded</span></code> flag is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>:</p>
<ol class="arabic simple">
<li><p>API Gateway knows to treat the <code class="docutils literal notranslate"><span class="pre">body</span></code> field as Base64-encoded binary data.</p></li>
<li><p>API Gateway decodes the Base64 string back into binary before sending the response to the client.
If the flag is not set, API Gateway assumes the <code class="docutils literal notranslate"><span class="pre">body</span></code> is plain text and tries to interpret or handle it as such, which can lead to issues when dealing with binary files like images, audio, or other non-textual data.</p></li>
</ol>
</section>
<section id="example-usage">
<h3>Example Usage<a class="headerlink" href="#example-usage" title="Link to this heading">¶</a></h3>
<section id="lambda-function">
<h4>Lambda Function:<a class="headerlink" href="#lambda-function" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>

<span class="k">def</span><span class="w"> </span><span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c1"># Load binary file content</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/path/to/image.png&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">binary_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># Encode binary data to Base64</span>
    <span class="n">base64_encoded_data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">binary_data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;image/png&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;isBase64Encoded&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Indicates the body contains Base64-encoded data</span>
        <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">base64_encoded_data</span>
    <span class="p">}</span>
</pre></div>
</div>
</section>
<section id="resulting-response-sent-to-client">
<h4>Resulting Response Sent to Client<a class="headerlink" href="#resulting-response-sent-to-client" title="Link to this heading">¶</a></h4>
<p>When the client makes a request, API Gateway:</p>
<ul class="simple">
<li><p>Decodes the Base64-encoded data back into binary.</p></li>
<li><p>Sends it to the client as raw binary data with the appropriate <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> header.
Without <code class="docutils literal notranslate"><span class="pre">isBase64Encoded:</span> <span class="pre">True</span></code>If the flag is omitted or set to <code class="docutils literal notranslate"><span class="pre">False</span></code>, the <code class="docutils literal notranslate"><span class="pre">body</span></code> is treated as a plain text string. For binary content, this results in corruption (e.g., images won’t display, audio files won’t play).</p></li>
</ul>
</section>
</section>
<section id="when-to-use">
<h3>When to Use<a class="headerlink" href="#when-to-use" title="Link to this heading">¶</a></h3>
<p>Use <code class="docutils literal notranslate"><span class="pre">&quot;isBase64Encoded&quot;:</span> <span class="pre">True</span></code> when:</p>
<ul class="simple">
<li><p>Your response includes binary content (e.g., <code class="docutils literal notranslate"><span class="pre">.mp3</span></code>, <code class="docutils literal notranslate"><span class="pre">.ico</span></code>, <code class="docutils literal notranslate"><span class="pre">.png</span></code>, <code class="docutils literal notranslate"><span class="pre">.jpg</span></code>).</p></li>
<li><p>You’re serving files or other binary data through Lambda and API Gateway.</p></li>
</ul>
</section>
<section id="sam-and-binary-media-types">
<h3>SAM and Binary Media Types<a class="headerlink" href="#sam-and-binary-media-types" title="Link to this heading">¶</a></h3>
<p>For this to work seamlessly, you must also configure API Gateway to support binary media types, as shown in your SAM <code class="docutils literal notranslate"><span class="pre">template.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">Resources</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ApiGateway</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Api</span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">BinaryMediaTypes</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">image/png</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">image/jpeg</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">image/x-icon</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audio/mpeg</span>
</pre></div>
</div>
<p>This configuration ensures API Gateway knows which content types should use the <code class="docutils literal notranslate"><span class="pre">isBase64Encoded</span></code> flag for binary responses.</p>
<p>You:</p>
<p>Why was this not a problem running under zappa?</p>
<p>ChatGPT:</p>
<p>The difference in behavior between Zappa and AWS SAM when serving static files or handling binary responses likely arises from <strong>how Zappa preconfigures API Gateway</strong>  and integrates with Lambda compared to SAM.</p>
</section>
<section id="key-differences-between-zappa-and-sam">
<h3>Key Differences Between Zappa and SAM:<a class="headerlink" href="#key-differences-between-zappa-and-sam" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Zappa Automates Binary Media Type Configuration</strong></p></li>
</ol>
<ul class="simple">
<li><p><strong>Zappa</strong> : By default, Zappa automatically sets up API Gateway to support common binary media types (e.g., images, audio, and others). It adds these types to the <code class="docutils literal notranslate"><span class="pre">BinaryMediaTypes</span></code> configuration in API Gateway, so files like <code class="docutils literal notranslate"><span class="pre">.mp3</span></code> or <code class="docutils literal notranslate"><span class="pre">.ico</span></code> are treated correctly.</p></li>
<li><p><strong>SAM</strong> : You must explicitly declare <code class="docutils literal notranslate"><span class="pre">BinaryMediaTypes</span></code> in the <code class="docutils literal notranslate"><span class="pre">template.yaml</span></code> file. If this step is skipped, API Gateway won’t handle binary responses properly, leading to UTF-8 decoding errors.</p></li>
</ul>
<ol class="arabic simple" start="2">
<li><p><strong>Response Handling</strong></p></li>
</ol>
<ul class="simple">
<li><p><strong>Zappa</strong> : It includes built-in middleware to handle binary file serving. Zappa transparently encodes binary data as Base64 when required and sets the <code class="docutils literal notranslate"><span class="pre">isBase64Encoded</span></code> flag in the Lambda response.</p></li>
<li><p><strong>SAM</strong> : SAM-generated Lambda functions don’t include this middleware by default. If your Lambda function sends binary data without setting <code class="docutils literal notranslate"><span class="pre">isBase64Encoded</span></code> or if API Gateway isn’t configured for binary media types, it will attempt to decode the response as UTF-8, causing errors.</p></li>
</ul>
<ol class="arabic simple" start="3">
<li><p><strong>Static File Handling</strong></p></li>
</ol>
<ul class="simple">
<li><p><strong>Zappa</strong> : Zappa has mechanisms to serve static files (like <code class="docutils literal notranslate"><span class="pre">.mp3</span></code> or <code class="docutils literal notranslate"><span class="pre">.ico</span></code>) from the <code class="docutils literal notranslate"><span class="pre">/static</span></code> path or an associated S3 bucket. It manages the correct <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> and binary handling automatically.</p></li>
<li><p><strong>SAM</strong> : SAM doesn’t provide direct support for static files. You need to either:</p>
<ul>
<li><p>Serve static files directly from S3 via a public bucket.</p></li>
<li><p>Implement the file-serving logic in your Lambda function, including setting the correct headers and handling binary data.</p></li>
</ul>
</li>
</ul>
<ol class="arabic simple" start="4">
<li><p><strong>Built-In Middleware in Zappa</strong>
Zappa includes middleware that handles:</p></li>
</ol>
<ul class="simple">
<li><p>Automatic Base64 encoding for binary responses.</p></li>
<li><p>Correct content-type inference for static files.</p></li>
</ul>
<p>With SAM, you’re responsible for implementing this functionality in your Lambda function, or you must configure your API Gateway properly.</p>
</section>
<section id="why-this-didn-t-occur-with-zappa">
<h3>Why This Didn’t Occur with Zappa<a class="headerlink" href="#why-this-didn-t-occur-with-zappa" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Binary Media Types Already Configured</strong> : Zappa preconfigured API Gateway to handle binary media types correctly.</p></li>
<li><p><strong>Built-In Base64 Encoding</strong> : Zappa’s middleware automatically Base64-encoded binary content and set the <code class="docutils literal notranslate"><span class="pre">isBase64Encoded</span></code> flag.</p></li>
<li><p><strong>Static File Handling</strong> : Zappa simplified serving static files, ensuring correct MIME types and response handling out of the box.</p></li>
<li><p><strong>Default Assumptions About Application Needs</strong> : Zappa was built specifically for deploying Python WSGI applications, so it handled common issues like binary responses automatically.</p></li>
</ol>
</section>
<section id="fixing-this-with-sam">
<h3>Fixing This with SAM<a class="headerlink" href="#fixing-this-with-sam" title="Link to this heading">¶</a></h3>
<p>To replicate Zappa’s behavior in SAM, ensure the following:</p>
<ol class="arabic simple">
<li><p><strong>Add Binary Media Types to API Gateway</strong> :
Update your <code class="docutils literal notranslate"><span class="pre">template.yaml</span></code>:</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">Resources</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ApiGateway</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Api</span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">BinaryMediaTypes</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">image/x-icon</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audio/mpeg</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">application/json</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">application/octet-stream</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p><strong>Encode Binary Responses in Your Lambda Function</strong> :
Explicitly encode binary data as Base64 and set <code class="docutils literal notranslate"><span class="pre">isBase64Encoded</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> in your Lambda response.</p></li>
<li><p><strong>Serve Static Files From S3</strong> :
Offload static file serving to S3, where files are served directly with proper MIME types and without encoding issues.</p></li>
<li><p><strong>Use Middleware for Binary Handling</strong> :
Include middleware (like <code class="docutils literal notranslate"><span class="pre">mangum</span></code> for ASGI apps) if needed to manage Base64 encoding and API Gateway integration. For Bottle:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>mangum
</pre></div>
</div>
<p>Update your Lambda handler:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mangum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mangum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bottle</span><span class="w"> </span><span class="kn">import</span> <span class="n">Bottle</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Bottle</span><span class="p">()</span>

<span class="c1"># Define routes...</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">Mangum</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
<p>By replicating these behaviors in SAM, you can match the functionality you previously had with Zappa.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Plant Tracer Web Application</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="UserTutorial.html">Plant Tracer Web App Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="VideoResizing.html">Resizing Video Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="ReleaseHistory.html">Plant-Tracer/webapp Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_mode.html">Demo Mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="DeveloperSetup.html">Developer Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="DevSetupAmazonLinuxEC2.html">Developer Setup on Amazon Linux 2023 on AWS EC2</a></li>
<li class="toctree-l1"><a class="reference internal" href="DevSetupUbuntu.html">Setting Up Plant-Tracer webapp on Ubuntu 24.04</a></li>
<li class="toctree-l1"><a class="reference internal" href="WindowsDevSetup.html">Windows Developer Setup Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Local%20Development%20and%20Github%20Actions.html">Local Development and GitHub Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="EnvironmentVariables.html">Environment Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamoDB.html">DynamoDB and Plant Tracer</a></li>
<li class="toctree-l1"><a class="reference internal" href="S3.html">S3 and Plant Tracer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="THEORY_OF_DESIGN.html">Web app theory of design</a></li>
<li class="toctree-l1"><a class="reference internal" href="gallery.html">Gallery of Plant Videos</a></li>
<li class="toctree-l1"><a class="reference internal" href="gallery_learning_plan.html">Gallery Learning Plan</a></li>
<li class="toctree-l1"><a class="reference internal" href="movie_player.html">Design of the movie player</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="user%20story%20-%20tracking.html">Upload and Track User Story</a></li>
<li class="toctree-l1"><a class="reference internal" href="NOTES_ON_SIMPLIFYING.html">Notes on simplfying the implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuring_aws.html">Configuring AWS</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">SAM Readme</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#planttracer-webapp">planttracer-webapp</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deploy-the-application">Deploy the application</a></li>
<li class="toctree-l2"><a class="reference internal" href="#use-the-sam-cli-to-build-and-test-locally">Use the SAM CLI to build and test locally</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fetch-tail-and-filter-lambda-function-logs">Fetch, tail, and filter Lambda function logs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tests">Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cleanup">Cleanup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#educational-resources">Educational Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#sam-programmer-notes">SAM Programmer notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#handling-binary-types">Handling binary types</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="sam_notes.html">Notes on Deploying to SAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="mv1.html">Configuration on mv1</a></li>
<li class="toctree-l1"><a class="reference internal" href="notes_on_resizing.html">Notes on Resizing</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="configuring_aws.html" title="previous chapter">Configuring AWS</a></li>
      <li>Next: <a href="sam_notes.html" title="next chapter">Notes on Deploying to SAM</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2023-2025 Simson Garfinkel, Steven E. Barber, JoAnn Juzefyk, Eric D. Brenner.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/README_SAM.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>